{% set RABBITMQ = properties or {} %}
{% set RABBITMQ_DISK = RABBITMQ['disk'] or 'rabbitmq-disk' %}
{% set RABBITMQ_FSTYPE = RABBITMQ['fstype'] or 'ext4' %}
{% set RABBITMQ_IPS = RABBITMQ['ips'] %}
{% set RABBITMQ_USERNAME = RABBITMQ['username'] %}
{% set RABBITMQ_PASSWORD = RABBITMQ['password'] %}

resources:
{% if RABBITMQ_IPS %}
- name: rabbitmq-service
  type: Service
  properties:
    kind: Service
    apiVersion: v1
    metadata:
      name: rabbitmq-service
    spec:
      ports:
      - protocol: TCP
        port: 5672
        targetPort: 5672
- name: rabbitmq-endpoints
  type: Endpoints
  properties:
    kind: Endpoints
    apiVersion: v1
    metadata:
      name: rabbitmq-service
    subsets:
      - addresses:
          {% for IP in RABBITMQ_IPS %}
          - IP: {{ IP }}
          {% endfor %}
        ports:
          - port: 5672
{% else %}
- name: rabbitmq
  type: https://raw.githubusercontent.com/kubernetes/deployment-manager/master/templates/replicatedservice/v2/replicatedservice.py
  properties:
    service_port: 5672
    container_port: 5672
    replicas: 1
    image: gcr.io/dm-k8s-testing/rabbitmq:latest
    env:
    - name: RABBITMQ_DEFAULT_USER
      value: {{ RABBITMQ_USERNAME }}
    - name: RABBITMQ_DEFAULT_PASS
      value: {{ RABBITMQ_PASSWORD }}
    volumes:
      - mount_path: /var/lib/rabbitmq/
        gcePersistentDisk:
          pdName: {{ RABBITMQ_DISK }}
          fsType: {{ RABBITMQ_FSTYPE }}
{% endif %}
